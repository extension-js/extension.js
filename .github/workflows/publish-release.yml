name: Extension.js â€“ Release Publish

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "Release channel: next, stable, or canary (silent publish)"
        type: choice
        required: true
        options: [next, stable, canary]
      version:
        description: "Exact version (e.g., 3.0.0-next.17 or 3.0.0). Leave empty for auto canary version."
        type: string
        required: false

permissions:
  contents: write
  id-token: write
  deployments: write

concurrency:
  group: publish-${{ inputs.channel }}-${{ inputs.version || github.run_id }}
  cancel-in-progress: false

env:
  NPM_CONFIG_PROVENANCE: "true"

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: ${{ inputs.channel }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'
          always-auth: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: |
          # Build the develop/runtime layer and mirror built-in @extensions
          # into programs/develop/dist via the root postcompile hook.
          pnpm --filter extension-develop compile
          pnpm --filter extension-create compile
          pnpm --filter extension-install compile
          pnpm --filter extension compile
          node scripts/build-extensions.cjs

      - name: Run tests (CLI + Develop)
        run: pnpm -w test

      - name: Validate inputs
        id: validate
        run: |
          RAW='${{ inputs.version }}'
          CHANNEL='${{ inputs.channel }}'
          VERSION=$(echo "$RAW" | xargs)
          if [ "$CHANNEL" = "stable" ] && [ -z "$VERSION" ]; then
            echo "version required for stable" >&2
            exit 1
          fi
          if [ "$CHANNEL" = "next" ] && [ -z "$VERSION" ]; then
            echo "version required for next" >&2
            exit 1
          fi

          if [ "$CHANNEL" = "canary" ] && [ -z "$VERSION" ]; then
            BASE=$(node -p "require('./programs/cli/package.json').version.split('-')[0]")
            SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
            VERSION="${BASE}-canary.${GITHUB_RUN_NUMBER}.${SHA}"
          fi

          if [ "$CHANNEL" = "next" ]; then
            echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+-[0-9A-Za-z.-]+$' || { echo "version must be pre-release for next" >&2; exit 1; }
          elif [ "$CHANNEL" = "canary" ]; then
            echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+-[0-9A-Za-z.-]+$' || { echo "version must be pre-release for canary" >&2; exit 1; }
          else
            echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$' || { echo "version must be plain semver for stable" >&2; exit 1; }
          fi

          SHOULD_TAG=true
          if [ "$CHANNEL" = "canary" ]; then SHOULD_TAG=false; fi
          if [ "$SHOULD_TAG" = "true" ]; then
            if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION$"; then echo "tag v$VERSION already exists on origin" >&2; exit 1; fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [ "$CHANNEL" = "next" ]; then
            echo "tag=next" >> $GITHUB_OUTPUT
          elif [ "$CHANNEL" = "canary" ]; then
            echo "tag=canary" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi
          echo "should_tag=$SHOULD_TAG" >> $GITHUB_OUTPUT

      - name: Generate release notes from git history
        if: ${{ inputs.channel != 'canary' }}
        id: changelog
        env:
          CURRENT_VERSION: ${{ steps.validate.outputs.version }}
        run: |
          set -euo pipefail
          # Exclude the target release tag in case this job is rerun after tagging.
          last_tag=$(git tag --list 'v*' --sort=-v:refname | grep -E 'v[0-9]+\.[0-9]+\.[0-9]+$' | grep -Ev "^v${CURRENT_VERSION}$" | head -n 1 || true)

          if [ -n "$last_tag" ]; then
            range="$last_tag..HEAD"
          else
            range="HEAD"
          fi

          notes=$(git log "$range" --no-merges --pretty=format:'- %s (%h)')
          if [ -z "$notes" ]; then
            notes="- No changes listed."
          fi

          {
            echo "notes<<EOF"
            echo "$notes"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "from_tag=$last_tag" >> "$GITHUB_OUTPUT"

      - name: Configure git user
        if: ${{ steps.validate.outputs.should_tag == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump versions (all packages) and tag
        env:
          VERSION: ${{ steps.validate.outputs.version }}
          SHOULD_TAG: ${{ steps.validate.outputs.should_tag }}
        run: |
          node -e "const fs=require('fs');const v=process.env.VERSION;for(const p of ['programs/cli/package.json','programs/develop/package.json','programs/create/package.json','programs/install/package.json']){const j=JSON.parse(fs.readFileSync(p,'utf8'));j.version=v;fs.writeFileSync(p,JSON.stringify(j,null,2)+'\n')}"
          if [ "$SHOULD_TAG" = "true" ]; then
            git add programs/cli/package.json programs/develop/package.json programs/create/package.json programs/install/package.json
            if ! git diff --cached --quiet; then git commit -m "release(${{ inputs.channel }}): v${{ steps.validate.outputs.version }}"; fi
            git tag "v${{ steps.validate.outputs.version }}"
            git push
            git push --tags
          else
            echo "Canary channel: skipping commit/tag/push."
          fi

      - name: Create GitHub Release
        if: ${{ inputs.channel != 'canary' }}
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.validate.outputs.version }}
          CHANNEL: ${{ inputs.channel }}
          RELEASE_NOTES: ${{ steps.changelog.outputs.notes }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const notes = (process.env.RELEASE_NOTES || '').trim();
            const version = process.env.VERSION;
            const date = new Intl.DateTimeFormat('en-US', {
              month: 'long',
              day: 'numeric',
              year: 'numeric',
              timeZone: 'UTC'
            }).format(new Date());
            const body = notes ? notes : 'No changes listed.';
            await github.rest.repos.createRelease({
              ...context.repo,
              tag_name: `v${version}`,
              name: `${version} (${date})`,
              body,
              draft: false,
              prerelease: process.env.CHANNEL === 'next'
            });

      - name: Update changelog for stable release
        if: ${{ inputs.channel == 'stable' }}
        env:
          VERSION: ${{ steps.validate.outputs.version }}
          RELEASE_NOTES: ${{ steps.changelog.outputs.notes }}
        run: |
          node -e "
            const fs = require('fs');
            const version = process.env.VERSION;
            const path = 'CHANGELOG.md';
            const releaseNotes = (process.env.RELEASE_NOTES || '').trim() || '- No changes listed.';
            const text = fs.readFileSync(path, 'utf8');
            const header = '## Unreleased';
            const withHeader = text.includes(header) ? text : header + '\\n\\n' + text;
            const start = withHeader.indexOf(header);
            if (start === -1) { throw new Error('CHANGELOG.md missing ## Unreleased section'); }
            const afterHeader = start + header.length;
            let nextHeader = withHeader.indexOf('\\n## ', afterHeader);
            if (nextHeader === -1) nextHeader = withHeader.length;
            const before = withHeader.slice(0, start);
            const after = withHeader.slice(nextHeader).replace(/^\\s+/, '');
            const date = new Intl.DateTimeFormat('en-US', {
              month: 'long',
              day: 'numeric',
              year: 'numeric',
              timeZone: 'UTC'
            }).format(new Date());
            const updated = [
              before,
              '## Unreleased\\n\\n',
              `## ${version} (${date})\\n\\n`,
              releaseNotes,
              '\\n\\n',
              after
            ].join('');
            fs.writeFileSync(path, updated);
          "
          git add CHANGELOG.md
          if ! git diff --cached --quiet; then
            git commit -m "chore(release): move changelog to v${{ steps.validate.outputs.version }}"
            git push
          else
            echo "No changelog updates to commit."
          fi

      - name: Prepare publish-only dependency rewrite (extension -> packages)
        env:
          VERSION: ${{ steps.validate.outputs.version }}
        run: |
          node -e "
            const fs=require('fs');
            const p='programs/cli/package.json';
            const j=JSON.parse(fs.readFileSync(p,'utf8'));
            if(j.dependencies && j.dependencies['extension-develop'] && /^workspace:/.test(j.dependencies['extension-develop'])){
              j.dependencies['extension-develop'] = process.env.VERSION;
            }
            if(j.dependencies && j.dependencies['extension-create'] && /^workspace:/.test(j.dependencies['extension-create'])){
              j.dependencies['extension-create'] = process.env.VERSION;
            }
            if(j.dependencies && j.dependencies['extension-install'] && /^workspace:/.test(j.dependencies['extension-install'])){
              j.dependencies['extension-install'] = process.env.VERSION;
            }
            fs.writeFileSync(p, JSON.stringify(j,null,2)+'\n');
          "

      - name: Verify npm registry
        run: npm config get registry

      - name: Check if version exists (extension-create)
        id: check_create
        working-directory: programs/create
        run: |
          PKG=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          if npm view "$PKG@$VER" version >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish extension-create [token+provenance]
        if: steps.check_create.outputs.exists == 'false'
        working-directory: programs/create
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "NPM_TOKEN secret is missing." >&2
            exit 1
          fi
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            mkdir -p "$(dirname "$NPM_CONFIG_USERCONFIG")"
            {
              echo "registry=https://registry.npmjs.org/"
              echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}"
              echo "always-auth=true"
            } > "$NPM_CONFIG_USERCONFIG"
          else
            {
              echo "registry=https://registry.npmjs.org/"
              echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}"
              echo "always-auth=true"
            } > "$HOME/.npmrc"
          fi
          npm publish --access public --tag ${{ steps.validate.outputs.tag }} --provenance --no-git-checks

      # Ensure npm has replicated the new version before proceeding.
      - name: Verify publish (extension-create)
        if: steps.check_create.outputs.exists == 'false'
        working-directory: programs/create
        run: |
          PKG=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          echo "Verifying $PKG@$VER is visible on npm..."
          for i in {1..12}; do
            if npm view "$PKG@$VER" version >/dev/null 2>&1; then
              echo "Found $PKG@$VER on npm."
              exit 0
            fi
            echo "Waiting for npm replication... ($i/12)"
            sleep 10
          done
          echo "Publish not visible on npm after waiting." >&2
          exit 1

      - name: Check if version exists (extension-develop)
        id: check_develop
        working-directory: programs/develop
        run: |
          PKG=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          if npm view "$PKG@$VER" version >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish extension-develop [token+provenance]
        if: steps.check_develop.outputs.exists == 'false'
        working-directory: programs/develop
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "NPM_TOKEN secret is missing." >&2
            exit 1
          fi
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            mkdir -p "$(dirname "$NPM_CONFIG_USERCONFIG")"
            {
              echo "registry=https://registry.npmjs.org/"
              echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}"
              echo "always-auth=true"
            } > "$NPM_CONFIG_USERCONFIG"
          else
            {
              echo "registry=https://registry.npmjs.org/"
              echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}"
              echo "always-auth=true"
            } > "$HOME/.npmrc"
          fi
          npm publish --access public --tag ${{ steps.validate.outputs.tag }} --provenance --no-git-checks

      # Ensure npm has replicated the new version before proceeding.
      - name: Verify publish (extension-develop)
        if: steps.check_develop.outputs.exists == 'false'
        working-directory: programs/develop
        run: |
          PKG=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          echo "Verifying $PKG@$VER is visible on npm..."
          for i in {1..12}; do
            if npm view "$PKG@$VER" version >/dev/null 2>&1; then
              echo "Found $PKG@$VER on npm."
              exit 0
            fi
            echo "Waiting for npm replication... ($i/12)"
            sleep 10
          done
          echo "Publish not visible on npm after waiting." >&2
          exit 1

      - name: Check if version exists (extension-install)
        id: check_install
        working-directory: programs/install
        run: |
          PKG=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          if npm view "$PKG@$VER" version >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish extension-install [token+provenance]
        if: steps.check_install.outputs.exists == 'false'
        working-directory: programs/install
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "NPM_TOKEN secret is missing." >&2
            exit 1
          fi
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            mkdir -p "$(dirname "$NPM_CONFIG_USERCONFIG")"
            {
              echo "registry=https://registry.npmjs.org/"
              echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}"
              echo "always-auth=true"
            } > "$NPM_CONFIG_USERCONFIG"
          else
            {
              echo "registry=https://registry.npmjs.org/"
              echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}"
              echo "always-auth=true"
            } > "$HOME/.npmrc"
          fi
          npm publish --access public --tag ${{ steps.validate.outputs.tag }} --provenance --no-git-checks

      - name: Verify publish (extension-install)
        if: steps.check_install.outputs.exists == 'false'
        working-directory: programs/install
        run: |
          PKG=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          echo "Verifying $PKG@$VER is visible on npm..."
          for i in {1..12}; do
            if npm view "$PKG@$VER" version >/dev/null 2>&1; then
              echo "Found $PKG@$VER on npm."
              exit 0
            fi
            echo "Waiting for npm replication... ($i/12)"
            sleep 10
          done
          echo "Publish not visible on npm after waiting." >&2
          exit 1

      - name: Check if version exists (extension)
        id: check_cli
        working-directory: programs/cli
        run: |
          PKG=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          if npm view "$PKG@$VER" version >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish extension [token+provenance]
        if: steps.check_cli.outputs.exists == 'false'
        working-directory: programs/cli
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "NPM_TOKEN secret is missing." >&2
            exit 1
          fi
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            mkdir -p "$(dirname "$NPM_CONFIG_USERCONFIG")"
            {
              echo "registry=https://registry.npmjs.org/"
              echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}"
              echo "always-auth=true"
            } > "$NPM_CONFIG_USERCONFIG"
          else
            {
              echo "registry=https://registry.npmjs.org/"
              echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}"
              echo "always-auth=true"
            } > "$HOME/.npmrc"
          fi
          npm publish --access public --tag ${{ steps.validate.outputs.tag }} --provenance --no-git-checks

      # Ensure npm has replicated the new version before proceeding.
      - name: Verify publish (extension)
        if: steps.check_cli.outputs.exists == 'false'
        working-directory: programs/cli
        run: |
          PKG=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          echo "Verifying $PKG@$VER is visible on npm..."
          for i in {1..12}; do
            if npm view "$PKG@$VER" version >/dev/null 2>&1; then
              echo "Found $PKG@$VER on npm."
              exit 0
            fi
            echo "Waiting for npm replication... ($i/12)"
            sleep 10
          done
          echo "Publish not visible on npm after waiting." >&2
          exit 1

      - name: Create GitHub Deployment (in_progress)
        if: ${{ inputs.channel != 'canary' }}
        id: create_deployment
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.validate.outputs.version }}
          CHANNEL: ${{ inputs.channel }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const ref = `v${process.env.VERSION}`;
            const channel = process.env.CHANNEL;
            const transient = channel === 'next';
            const production = channel === 'stable';
            const res = await github.rest.repos.createDeployment({
              owner,
              repo,
              ref,
              environment: channel,
              auto_merge: false,
              required_contexts: [],
              description: `Release v${process.env.VERSION} to ${channel}`,
              transient_environment: transient,
              production_environment: production
            });
            core.setOutput('id', res.data.id);

      - name: Mark Deployment successful
        if: ${{ inputs.channel != 'canary' }}
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.validate.outputs.version }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const logUrl = `https://github.com/${owner}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id: Number('${{ steps.create_deployment.outputs.id }}'),
              state: 'success',
              environment: '${{ inputs.channel }}',
              log_url: logUrl,
              environment_url: `https://www.npmjs.com/package/extension/v/${process.env.VERSION}`,
              auto_inactive: true
            });

