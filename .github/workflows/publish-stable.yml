name: Release – Stable

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Exact stable version to publish (e.g., 2.2.1). Required."
        required: true
        type: string

permissions:
  contents: write
  id-token: write
  deployments: write

concurrency:
  group: publish-stable-${{ inputs.version }}
  cancel-in-progress: false

env:
  NPM_CONFIG_PROVENANCE: "true"

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: stable
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'
          always-auth: true
          cache: 'pnpm'

      # No token-based auth needed for trusted publishers
      - name: Verify npm registry
        env:
          NPM_CONFIG_WORKSPACES: "false"
        run: |
          npm config get registry

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: |
          pnpm --filter extension-develop compile
          pnpm --filter extension compile

      - name: Run tests (CLI + Develop)
        run: pnpm -w test

      - name: Validate version input
        id: validate
        run: |
          RAW='${{ inputs.version }}'
          VERSION=$(echo "$RAW" | xargs)
          if [ -z "$VERSION" ]; then
            echo "Error: version is required" >&2; exit 1
          fi
          if ! echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: '$VERSION' must be plain semver (no pre-release) for stable" >&2; exit 1
          fi
          if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION$"; then
            echo "Error: tag v$VERSION already exists on origin" >&2; exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump versions (both packages)
        env:
          VERSION: ${{ steps.validate.outputs.version }}
        run: |
          node -e "const fs=require('fs');const VERSION=process.env.VERSION;for(const p of ['programs/cli/package.json','programs/develop/package.json']){const j=JSON.parse(fs.readFileSync(p,'utf8'));j.version=VERSION;fs.writeFileSync(p,JSON.stringify(j,null,2)+'\n')}"
          git add programs/cli/package.json programs/develop/package.json
          git commit -m "release: v$VERSION"
          git tag "v$VERSION"

      - name: Push tag
        run: |
          git push
          git push --tags

      - name: Prepare publish-only dependency rewrite (extension -> extension-develop)
        run: |
          node -e "
            const fs=require('fs');
            const p='programs/cli/package.json';
            const j=JSON.parse(fs.readFileSync(p,'utf8'));
            if(j.dependencies && j.dependencies['extension-develop'] && /^workspace:/.test(j.dependencies['extension-develop'])){
              j.dependencies['extension-develop'] = '^'+process.env.VERSION;
              fs.writeFileSync(p, JSON.stringify(j,null,2)+'\n');
            }"
        env:
          VERSION: ${{ steps.validate.outputs.version }}

      - name: Check if version exists (extension-develop)
        id: check_develop
        working-directory: programs/develop
        run: |
          PKG=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          if npm view "$PKG@$VER" version >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "$PKG@$VER already exists on npm; will skip publish."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish extension-develop (tag=latest) [trusted publisher]
        if: steps.check_develop.outputs.exists == 'false'
        working-directory: programs/develop
        env:
          NPM_CONFIG_WORKSPACES: "false"
        run: |
          # Ensure token auth is not used; force trusted publish via OIDC
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ] && [ -f "$NPM_CONFIG_USERCONFIG" ]; then rm -f "$NPM_CONFIG_USERCONFIG"; fi
          rm -f "$HOME/.npmrc" || true
          npm config get registry
          npm publish --access public --tag latest --provenance --no-git-checks

      - name: Check if version exists (extension)
        id: check_cli
        working-directory: programs/cli
        run: |
          PKG=$(node -p "require('./package.json').name")
          VER=$(node -p "require('./package.json').version")
          if npm view "$PKG@$VER" version >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "$PKG@$VER already exists on npm; will skip publish."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish extension (tag=latest) [trusted publisher]
        if: steps.check_cli.outputs.exists == 'false'
        working-directory: programs/cli
        env:
          NPM_CONFIG_WORKSPACES: "false"
        run: |
          # Ensure token auth is not used; force trusted publish via OIDC
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ] && [ -f "$NPM_CONFIG_USERCONFIG" ]; then rm -f "$NPM_CONFIG_USERCONFIG"; fi
          rm -f "$HOME/.npmrc" || true
          npm config get registry
          npm publish --access public --tag latest --provenance --no-git-checks

      - name: Restore workspace dependency file (no repo mutation)
        run: git checkout -- programs/cli/package.json

      - name: Render release notes
        id: changelog
        env:
          VERSION: ${{ steps.validate.outputs.version }}
        run: |
          node ./scripts/render-aggregated-changelog.cjs > aggregated.md || true
          if [ ! -s aggregated.md ]; then
            echo "Release v$VERSION of Extension.js CLI and Develop." > aggregated.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.validate.outputs.version }}
          name: v${{ steps.validate.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body_path: aggregated.md

      - name: Create GitHub Deployment (stable, in_progress)
        id: create_deployment
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.validate.outputs.version }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const ref = `v${process.env.VERSION}`;
            const res = await github.rest.repos.createDeployment({
              owner,
              repo,
              ref,
              environment: 'stable',
              auto_merge: false,
              required_contexts: [],
              description: `Release ${ref} to stable`,
              transient_environment: false,
              production_environment: true
            });
            core.setOutput('id', res.data.id);

      - name: Mark Deployment successful (stable)
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.validate.outputs.version }}
          DEPLOYMENT_ID: ${{ steps.create_deployment.outputs.id }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const ref = `v${process.env.VERSION}`;
            await github.rest.repos.createDeploymentStatus({
              owner,
              repo,
              deployment_id: Number(process.env.DEPLOYMENT_ID),
              state: 'success',
              environment: 'stable',
              log_url: `https://github.com/${owner}/${repo}/releases/tag/${ref}`,
              environment_url: `https://www.npmjs.com/package/extension/v/${process.env.VERSION}`,
              auto_inactive: true
            });

      - name: Notify Discord
        if: ${{ success() }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL_RELEASES }}
          VERSION: ${{ steps.validate.outputs.version }}
        run: |
          CONTENT=$(sed -e 's/"/\\"/g' -e 's/\r//g' aggregated.md | sed -e 's/extension-develop/Extension.js/g' | head -c 3900 || true)
          if [ -z "$CONTENT" ]; then
            CONTENT="Shipped v$VERSION to npm — Extension.js."
          fi
          cat > payload.json << JSON
          {
            "username": "Extension.js Release",
            "embeds": [{
              "title": "v$VERSION",
              "url": "https://github.com/${GITHUB_REPOSITORY}/releases/tag/v$VERSION",
              "color": 16776960,
              "description": "$CONTENT",
              "fields": [
                { "name": "npm", "value": "[extension@$VERSION](https://www.npmjs.com/package/extension/v/$VERSION)", "inline": true }
              ],
              "footer": { "text": "Published with npm provenance" }
            }]
          }
          JSON
          curl -s -X POST -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK_URL" >/dev/null 2>&1 || true


